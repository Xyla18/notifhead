// Présence
window.togglePresence = async (concertId) => {
  const { data } = await supabase
    .from('presences')
    .select('*')
    .eq('concert_id', concertId)
    .eq('pseudo', pseudo);

  if (data && data.length > 0) {
    await supabase
      .from('presences')
      .delete()
      .eq('concert_id', concertId)
      .eq('pseudo', pseudo);
    alert("Tu n’es plus marqué présent ❌");
  } else {
    await supabase
      .from('presences')
      .insert([{ concert_id: concertId, pseudo }]);
    alert("Ta présence a été enregistrée ✅");
  }
  loadPresenceCount(concertId);
};

// Charger le nombre de présences
async function loadPresenceCount(concertId) {
  const { data } = await supabase
    .from('presences')
    .select('*', { count: 'exact' })
    .eq('concert_id', concertId);

  const btn = document.querySelector(`#presence-${concertId} button`);
  btn.innerText = `✅ Je serai présent (${data.length})`;
}

// Ajouter un commentaire
window.addComment = async (concertId) => {
  const input = document.getElementById("input-" + concertId);
  const texte = input.value.trim();
  if (!texte) return;
  await supabase
    .from('commentaires')
    .insert([{ concert_id: concertId, pseudo, texte }]);
  input.value = "";
  loadComments(concertId);
};

// Supprimer son commentaire
window.deleteComment = async (id, concertId) => {
  await supabase
    .from('commentaires')
    .delete()
    .eq('id', id)
    .eq('pseudo', pseudo);
  loadComments(concertId);
};

// Charger les commentaires
async function loadComments(concertId) {
  const { data } = await supabase
    .from('commentaires')
    .select('*')
    .eq('concert_id', concertId)
    .order('created_at', { ascending: true });

  const box = document.getElementById("comments-" + concertId);
  box.innerHTML = "";

  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `<strong>${c.pseudo}</strong> : ${c.texte}
      ${c.pseudo === pseudo ? `<button onclick="deleteComment(${c.id}, ${concertId})" style="float:right;color:red;">x</button>` : ""}`;
    box.appendChild(div);
  });
}
