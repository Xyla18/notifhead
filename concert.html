<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Concerts</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:#f9f9f9; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#202020; color:#fff; }
header h1 { margin:0; font-size:1.8rem; }
header button { background:#00ccff; color:#000; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.container { max-width:900px; margin:24px auto; display:flex; flex-direction:column; gap:24px; padding:0 16px; }
.card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.15); }
.card h2 { margin-top:0; }
button { margin:4px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.present { background:#00ccff; color:#fff; }
.absent { background:#ff5555; color:#fff; }
.comment-form input { width:60%; padding:6px; border-radius:6px; margin-right:6px; }
.comment-form button { background:#00ccff; color:#fff; }
.comments { margin-top:12px; }
.participants { margin-top:8px; font-size:0.95rem; }
img.concert-img { max-width:100%; border-radius:8px; margin-top:8px; }
</style>
</head>
<body>
<header>
  <button id="btnBack">← Retour</button>
  <h1>Concerts à venir</h1>
  <button id="btnLogin">Admin</button>
</header>

<div class="container" id="concertList">
<p>Chargement des concerts...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, addDoc } 
  from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// ===== Config Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.firebasestorage.app",
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const container = document.getElementById("concertList");
const concertsRef = collection(db,"concerts");
const concertsQuery = query(concertsRef, orderBy("date"));

// Navigation
document.getElementById("btnBack").onclick = ()=>{ window.history.back(); }
document.getElementById("btnLogin").onclick = ()=>{ window.location.href="admin.html"; }

// Ajouter participant
async function addParticipant(concertId, name, status){
  if(!name) return;
  const userRef = doc(db,"concerts",concertId,"participants",name);
  await setDoc(userRef,{ name, status });
}

// Ajouter commentaire
async function addComment(concertId, name, text){
  if(!name||!text) return;
  const commentsRef = collection(db,"concerts",concertId,"comments");
  await addDoc(commentsRef,{ name,text });
}

// Affichage en temps réel
onSnapshot(concertsQuery, snapshot=>{
  container.innerHTML="";
  snapshot.forEach(docSnap=>{
    const c = docSnap.data();
    const concertId = docSnap.id;
    const div = document.createElement("div");
    div.className="card";

    // Image depuis Firebase Storage
    let imgTag = '';
    if(c.imagePath){
      const imgRef = ref(storage, c.imagePath);
      getDownloadURL(imgRef).then(url=>{
        const imgEl = document.createElement("img");
        imgEl.src = url;
        imgEl.className="concert-img";
        div.prepend(imgEl);
      });
    }

    div.innerHTML += `
      <h2>${c.title}</h2>
      <p>${c.date} ${c.time || ''} — ${c.lieu || ''}</p>
      <p>${c.desc || ''}</p>
      <button class="present">✅ Je viens</button>
      <button class="absent">❌ Je ne viens pas</button>
      <div class="participants">Chargement participants...</div>
      <div class="comments">Chargement commentaires...</div>
      <div class="comment-form">
        <input type="text" placeholder="Nom" class="user">
        <input type="text" placeholder="Commentaire" class="text">
        <button class="add-comment">Ajouter</button>
      </div>
    `;
    container.appendChild(div);

    // Participants en temps réel
    const participantsCol = collection(db,"concerts",concertId,"participants");
    onSnapshot(participantsCol, partSnap=>{
      const present = [], absent = [];
      partSnap.forEach(p=>{ const d=p.data(); if(d.status==="present") present.push(d.name); if(d.status==="absent") absent.push(d.name); });
      div.querySelector(".participants").innerHTML = `✅ Présents: ${present.join(", ")||"-"}<br>❌ Absents: ${absent.join(", ")||"-"}`;
    });

    // Commentaires en temps réel
    const commentsCol = collection(db,"concerts",concertId,"comments");
    onSnapshot(commentsCol, comSnap=>{
      div.querySelector(".comments").innerHTML = comSnap.docs.map(doc=>`<div><strong>${doc.data().name}:</strong> ${doc.data().text}</div>`).join("");
    });

    div.querySelector(".present").onclick = ()=>{
      const name = prompt("Votre nom pour confirmer la présence:");
      addParticipant(concertId,name,"present");
    };
    div.querySelector(".absent").onclick = ()=>{
      const name = prompt("Votre nom pour confirmer l'absence:");
      addParticipant(concertId,name,"absent");
    };
    div.querySelector(".add-comment").onclick = ()=>{
      const name = div.querySelector(".user").value.trim();
      const text = div.querySelector(".text").value.trim();
      addComment(concertId,name,text);
      div.querySelector(".user").value="";
      div.querySelector(".text").value="";
    };
  });
});
</script>
</body>
</html>
