<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Concerts √† venir</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:#f9f9f9; color:#111; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#202020; color:#fff; }
header h1 { margin:0; font-size:1.6rem; }
header button { background:#00ccff; color:#000; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.container { max-width:900px; margin:24px auto; display:flex; flex-direction:column; gap:20px; padding:0 16px; }
.card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.15); }
.card h2 { margin-top:0; }
button { margin:4px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.present { background:#00ccff; color:#fff; }
.absent { background:#ff5555; color:#fff; }
.remove-btn { background:#777; color:#fff; margin-left:8px; }
.comment-form input { width:60%; padding:6px; border-radius:6px; margin-right:6px; border:1px solid #ccc; }
.comment-form button { background:#00ccff; color:#fff; }
.comments { margin-top:12px; }
.comment-item { margin-top:6px; padding:6px; background:#f1f1f1; border-radius:6px; }
.participants { margin-top:8px; font-size:0.95rem; }
img.concert-img { max-width:100%; border-radius:8px; margin-top:8px; }
</style>
</head>
<body>

<header>
  <button id="btnBack">‚Üê Retour</button>
  <h1>Concerts √† venir</h1>
  <button id="btnLogin">Admin</button>
</header>

<div class="container" id="concertList">
  <p>Chargement des concerts...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, deleteDoc, addDoc } 
  from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// === Config Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.firebasestorage.app",
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// === Navigation ===
document.getElementById("btnBack").onclick = ()=> window.history.back();
document.getElementById("btnLogin").onclick = ()=> window.location.href = "login.html";

// === Gestion du pseudo local ===
let username = localStorage.getItem("concert_username");
if (!username) {
  username = prompt("Entre ton pseudo pour cette session :");
  if (username) localStorage.setItem("concert_username", username);
  else username = "Anonyme";
}

// === Fonctions Firestore ===
async function addParticipant(concertId, name, status) {
  const userRef = doc(db, "concerts", concertId, "participants", name);
  await setDoc(userRef, { name, status });
}

async function removeParticipant(concertId, name) {
  const userRef = doc(db, "concerts", concertId, "participants", name);
  await deleteDoc(userRef);
}

async function addComment(concertId, name, text) {
  const commentsRef = collection(db, "concerts", concertId, "comments");
  await addDoc(commentsRef, { name, text });
}

async function deleteComment(concertId, commentId) {
  await deleteDoc(doc(db, "concerts", concertId, "comments", commentId));
}

// === R√©cup√©ration concerts ===
const container = document.getElementById("concertList");
const concertsRef = collection(db, "concerts");
const concertsQuery = query(concertsRef, orderBy("date"));

onSnapshot(concertsQuery, snapshot => {
  container.innerHTML = "";
  snapshot.forEach(async docSnap => {
    const c = docSnap.data();
    const concertId = docSnap.id;
    const div = document.createElement("div");
    div.className = "card";

    // Image depuis Firebase Storage
    if (c.imagePath) {
      const imgRef = ref(storage, c.imagePath);
      const url = await getDownloadURL(imgRef);
      const imgEl = document.createElement("img");
      imgEl.src = url;
      imgEl.className = "concert-img";
      div.appendChild(imgEl);
    }

    // === Bloc info concert ===
    div.innerHTML += `
      <h2>${c.title}</h2>
      <p>
        <span class="date-link" style="color:#00f; cursor:pointer;">üìÖ ${c.date} ${c.time || ''}</span> ‚Äî
        <span class="lieu-link" style="color:#00f; cursor:pointer;">üìç ${c.lieu || ''}</span>
      </p>
      <p>${c.desc || ''}</p>
      <button class="present">‚úÖ Je viens</button>
      <button class="absent">‚ùå Je ne viens pas</button>
      <button class="remove-btn">üóëÔ∏è Retirer ma pr√©sence</button>
      <div class="participants">Chargement participants...</div>
      <div class="comments">Chargement commentaires...</div>
      <div class="comment-form">
        <input type="text" placeholder="Ton commentaire..." class="text">
        <button class="add-comment">Ajouter</button>
      </div>
    `;
    container.appendChild(div);

    // === Lien calendrier ===
    div.querySelector(".date-link").onclick = () => {
      const startDate = new Date(c.date + "T" + (c.time || "19:00")).toISOString().replace(/[-:]|\.\d{3}/g, "");
      const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(c.title)}&dates=${startDate}/${startDate}&details=${encodeURIComponent(c.desc || '')}&location=${encodeURIComponent(c.lieu || '')}`;
      window.open(url, "_blank");
    };

    // === Lien Google Maps ===
    div.querySelector(".lieu-link").onclick = () => {
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.lieu)}`, "_blank");
    };

    // === Gestion des pr√©sences ===
    const participantsCol = collection(db, "concerts", concertId, "participants");
    onSnapshot(participantsCol, partSnap => {
      const present = [], absent = [];
      partSnap.forEach(p => {
        const d = p.data();
        if (d.status === "present") present.push(d.name);
        if (d.status === "absent") absent.push(d.name);
      });
      div.querySelector(".participants").innerHTML = `‚úÖ Pr√©sents: ${present.join(", ") || "-"}<br>‚ùå Absents: ${absent.join(", ") || "-"}`;
    });

    div.querySelector(".present").onclick = () => addParticipant(concertId, username, "present");
    div.querySelector(".absent").onclick = () => addParticipant(concertId, username, "absent");
    div.querySelector(".remove-btn").onclick = () => removeParticipant(concertId, username);

    // === Commentaires ===
    const commentsCol = collection(db, "concerts", concertId, "comments");
    onSnapshot(commentsCol, comSnap => {
      const list = comSnap.docs.map(doc => {
        const d = doc.data();
        const canDelete = d.name === username;
        return `
          <div class="comment-item">
            <strong>${d.name} :</strong> ${d.text}
            ${canDelete ? `<button class="remove-comment" data-id="${doc.id}">üóëÔ∏è</button>` : ""}
          </div>
        `;
      }).join("");
      div.querySelector(".comments").innerHTML = list;

      // Suppression commentaire
      div.querySelectorAll(".remove-comment").forEach(btn => {
        btn.onclick = () => deleteComment(concertId, btn.dataset.id);
      });
    });

    // === Ajouter commentaire ===
    div.querySelector(".add-comment").onclick = () => {
      const text = div.querySelector(".text").value.trim();
      if (!text) return;
      addComment(concertId, username, text);
      div.querySelector(".text").value = "";
    };
  });
});
</script>

</body>
</html>
