<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Concerts</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:#f9f9f9; color:#111; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#202020; color:#fff; }
header h1 { margin:0; font-size:1.6rem; }
header button { background:#00ccff; color:#000; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.container { max-width:900px; margin:24px auto; display:flex; flex-direction:column; gap:20px; padding:0 16px; }
.card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.12); }
.card h2 { margin:0 0 6px 0; }
button.small { margin:6px 6px 6px 0; padding:6px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.present { background:#00ccff; color:#fff; }
.absent { background:#ff5555; color:#fff; }
.comment-form input { padding:8px; border-radius:8px; border:1px solid #ddd; margin-right:6px; }
img.concert-img { max-width:100%; border-radius:8px; margin-bottom:10px; display:block; }
.meta-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.comment-row { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:6px 0; }
.comment-row button { background:#ddd; color:#000; }
</style>
</head>
<body>
<header>
  <button id="btnBack">‚Üê Retour</button>
  <h1>Concerts √† venir</h1>
  <div>
    <button id="btnLoginGoogle">Connexion Google</button>
    <button id="btnLogout" style="display:none;">D√©connexion</button>
  </div>
</header>

<div class="container" id="concertList">
  <p>Chargement des concerts...</p>
</div>

<script type="module">
/* ========== Imports Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  doc, setDoc, addDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

/* ===== Config Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.firebasestorage.app",
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const container = document.getElementById("concertList");
const btnLogin = document.getElementById("btnLoginGoogle");
const btnLogout = document.getElementById("btnLogout");
let currentUser = null;

/* ==== Authentification Google ==== */
const provider = new GoogleAuthProvider();

btnLogin.onclick = () => signInWithPopup(auth, provider)
  .then(result => { console.log("Connect√©:", result.user.displayName); })
  .catch(err => alert("Erreur de connexion : " + err.message));

btnLogout.onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if(user){
    currentUser = user;
    btnLogin.style.display = "none";
    btnLogout.style.display = "inline-block";
    renderConcerts();
  } else {
    currentUser = null;
    btnLogin.style.display = "inline-block";
    btnLogout.style.display = "none";
    container.innerHTML = "<p>Veuillez vous connecter pour voir les concerts.</p>";
  }
});

/* ==== Fonctions Firestore ==== */
async function addParticipant(concertId, name, status, uid){
  const userRef = doc(db, "concerts", concertId, "participants", uid);
  await setDoc(userRef, { name, status, uid, updatedAt: Date.now() });
}

async function removeParticipant(concertId, uid){
  const userRef = doc(db, "concerts", concertId, "participants", uid);
  await deleteDoc(userRef);
}

async function addComment(concertId, name, text, uid){
  const commentsRef = collection(db, "concerts", concertId, "comments");
  await addDoc(commentsRef, { name, text, uid, createdAt: Date.now() });
}

async function deleteComment(concertId, commentId){
  const cDoc = doc(db, "concerts", concertId, "comments", commentId);
  await deleteDoc(cDoc);
}

/* ==== Affichage des concerts ==== */
function renderConcerts(){
  const concertsRef = collection(db, "concerts");
  const concertsQuery = query(concertsRef, orderBy("date"));
  onSnapshot(concertsQuery, snapshot => {
    container.innerHTML = "";
    if(snapshot.empty){
      container.innerHTML = "<p>Aucun concert pour l'instant.</p>";
      return;
    }
    snapshot.forEach(docSnap => {
      const c = docSnap.data();
      const concertId = docSnap.id;
      const div = document.createElement("div");
      div.className = "card";

      // Image
      if(c.imagePath){
        const imgRef = ref(storage, c.imagePath);
        getDownloadURL(imgRef).then(url=>{
          const imgEl = document.createElement("img");
          imgEl.src = url;
          imgEl.className = "concert-img";
          div.prepend(imgEl);
        });
      }

      const title = document.createElement("h2");
      title.textContent = c.title || "Concert";
      div.appendChild(title);

      const pInfo = document.createElement("p");
      pInfo.textContent = `${c.date} ${c.time || ""} ‚Äî ${c.lieu || ""}`;
      div.appendChild(pInfo);

      const pDesc = document.createElement("p");
      pDesc.textContent = c.desc || "";
      div.appendChild(pDesc);

      // Boutons de pr√©sence
      const presentBtn = document.createElement("button");
      presentBtn.className = "small present";
      presentBtn.textContent = "‚úÖ Je viens";
      presentBtn.onclick = () => {
        if(!currentUser) return alert("Connecte-toi d'abord !");
        addParticipant(concertId, currentUser.displayName, "present", currentUser.uid);
      };

      const absentBtn = document.createElement("button");
      absentBtn.className = "small absent";
      absentBtn.textContent = "‚ùå Je ne viens pas";
      absentBtn.onclick = () => {
        if(!currentUser) return alert("Connecte-toi d'abord !");
        addParticipant(concertId, currentUser.displayName, "absent", currentUser.uid);
      };

      const removeBtn = document.createElement("button");
      removeBtn.className = "small";
      removeBtn.textContent = "üóëÔ∏è Retirer ma pr√©sence";
      removeBtn.onclick = () => {
        if(!currentUser) return alert("Connecte-toi d'abord !");
        removeParticipant(concertId, currentUser.uid);
      };

      const metaRow = document.createElement("div");
      metaRow.className = "meta-row";
      metaRow.append(presentBtn, absentBtn, removeBtn);
      div.appendChild(metaRow);

      // Participants
      const participantsDiv = document.createElement("div");
      participantsDiv.innerHTML = "Chargement participants...";
      div.appendChild(participantsDiv);

      onSnapshot(collection(db,"concerts",concertId,"participants"), partSnap=>{
        const present = [], absent = [];
        partSnap.forEach(p=>{
          const d = p.data();
          if(d.status==="present") present.push(d.name);
          else if(d.status==="absent") absent.push(d.name);
        });
        participantsDiv.innerHTML = `‚úÖ Pr√©sents: ${present.join(", ")||"-"}<br>‚ùå Absents: ${absent.join(", ")||"-"}`;
      });

      // Commentaires
      const commentsDiv = document.createElement("div");
      commentsDiv.className = "comments";
      commentsDiv.innerHTML = "<strong>Commentaires:</strong>";
      div.appendChild(commentsDiv);

      const comCol = collection(db, "concerts", concertId, "comments");
      onSnapshot(comCol, comSnap => {
        const list = document.createElement("div");
        comSnap.forEach(docCom=>{
          const d = docCom.data();
          const row = document.createElement("div");
          row.className = "comment-row";
          row.innerHTML = `<span><strong>${d.name}</strong>: ${d.text}</span>`;
          if(currentUser && d.uid === currentUser.uid){
            const delBtn = document.createElement("button");
            delBtn.textContent = "üóëÔ∏è";
            delBtn.onclick = ()=> deleteComment(concertId, docCom.id);
            row.appendChild(delBtn);
          }
          list.appendChild(row);
        });
        commentsDiv.innerHTML = "<strong>Commentaires:</strong>";
        commentsDiv.appendChild(list);
      });

      // Formulaire commentaire
      const formDiv = document.createElement("div");
      formDiv.className = "comment-form";
      const input = document.createElement("input");
      input.placeholder = "Votre commentaire";
      const send = document.createElement("button");
      send.className = "small";
      send.textContent = "Publier";
      send.onclick = ()=>{
        if(!currentUser) return alert("Connecte-toi d'abord !");
        const text = input.value.trim();
        if(!text) return;
        addComment(concertId, currentUser.displayName, text, currentUser.uid);
        input.value="";
      };
      formDiv.append(input, send);
      div.appendChild(formDiv);

      container.appendChild(div);
    });
  });
}
</script>
</body>
</html>
