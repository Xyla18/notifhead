<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Concerts</title>
<style>
body{font-family:'Segoe UI',sans-serif;margin:0;background:#121212;color:#fff}
header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#000}
header h1{margin:0}
header button{padding:6px 12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
header button#btnLibrary{background:#00ccff;color:#000}
header button#btnLogout{background:#ff5555;color:#fff}
.container{max-width:800px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:24px}
.card{background:#1e1e1e;padding:16px;border-radius:12px}
input,textarea,button{width:100%;margin:6px 0;padding:8px;border-radius:6px;border:none}
input[type="file"]{padding:3px}
button.save{background:#00ccff;color:#000;font-weight:bold}
button.delete{background:#ff5555;color:#fff}
.concert-item{background:#2a2a2a;padding:12px;border-radius:8px;margin-bottom:12px}
img.concert-img{max-width:100%;border-radius:8px;margin-top:6px}
</style>
</head>
<body>
<header>
  <button id="btnLibrary">Bibliothèque</button>
  <h1>Admin Concerts</h1>
  <button id="btnLogout">Déconnexion</button>
</header>

<div class="container">
  <div class="card">
    <h2>Ajouter / Modifier un concert</h2>
    <form id="form">
      <input type="hidden" id="concertId">
      <input id="title" placeholder="Titre" required>
      <input type="date" id="date">
      <input type="time" id="time">
      <input id="lieu" placeholder="Lieu">
      <textarea id="description" placeholder="Description"></textarea>
      <input type="file" id="image" accept="image/*">
      <button type="submit" class="save">Publier</button>
    </form>
  </div>

  <h2>Liste des concerts</h2>
  <div id="concertList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://hcjgggdnfznoitebphvs.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjamdnZ2RuZnpub2l0ZWJwaHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA1MDEsImV4cCI6MjA3NjA5NjUwMX0.evgN1B1dp8H0007N4qskRxXiAICJPajBAbgYFsPyX3s";

const supabase = createClient(supabaseUrl, supabaseKey);

document.getElementById("btnLibrary").onclick = ()=>window.location.href="musiques.html";
document.getElementById("btnLogout").onclick = ()=>window.location.href="index.html";

const form=document.getElementById("form");
const list=document.getElementById("concertList");

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const concertId=document.getElementById("concertId").value;
  const title=document.getElementById("title").value;
  const date=document.getElementById("date").value;
  const time=document.getElementById("time").value;
  const lieu=document.getElementById("lieu").value;
  const description=document.getElementById("description").value;
  const file=document.getElementById("image").files[0];

  try{
    let image_url = null;
    if(file){
      const { data, error } = await supabase.storage.from('concertImages').upload(`images/${Date.now()}_${file.name}`, file, { upsert: true });
      if(error) throw error;
      const { publicURL } = supabase.storage.from('concertImages').getPublicUrl(data.path);
      image_url = publicURL;
    }

    const obj = { title, date, time, lieu, description };
    if(image_url) obj.image_url = image_url;

    if(concertId){
      await supabase.from('concerts').update(obj).eq('id', concertId);
    }else{
      await supabase.from('concerts').insert([obj]);
    }

    form.reset(); document.getElementById("concertId").value="";
    alert("✅ Concert publié !");
    loadConcerts();
  }catch(err){ console.error(err); alert("❌ Erreur: "+err.message); }
});

async function loadConcerts(){
  const { data, error } = await supabase.from('concerts').select('*').order('id',{ascending:true});
  if(error){ list.innerHTML="Erreur: "+error.message; return; }
  list.innerHTML="";
  data.forEach(c=>{
    const div=document.createElement("div"); div.className="concert-item";

    if(c.image_url){
      const img=document.createElement("img"); img.src=c.image_url; img.className="concert-img"; div.appendChild(img);
    }

    div.innerHTML += `<strong>${c.title}</strong> - ${c.date || ''} ${c.time || ''}<br><em>${c.lieu || ''}</em><br>${c.description || ''}<br>`;

    const btnEdit=document.createElement("button"); btnEdit.innerText="Modifier"; btnEdit.className="save";
    btnEdit.onclick=()=>{ 
      document.getElementById("concertId").value=c.id;
      document.getElementById("title").value=c.title;
      document.getElementById("date").value=c.date;
      document.getElementById("time").value=c.time;
      document.getElementById("lieu").value=c.lieu;
      document.getElementById("description").value=c.description;
    };
    div.appendChild(btnEdit);

    const btnDelete=document.createElement("button"); btnDelete.innerText="Supprimer"; btnDelete.className="delete";
    btnDelete.onclick=async()=>{ await supabase.from('concerts').delete().eq('id',c.id); loadConcerts(); };
    div.appendChild(btnDelete);

    list.appendChild(div);
  });
}

loadConcerts();
</script>
</body>
</html>
