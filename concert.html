<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Concerts</title>
<style>
  :root{--bg:#f9f9f9;--card:#fff;--muted:#666;--primary:#00ccff;--danger:#ff5555}
  body{font-family:Segoe UI, Roboto, sans-serif;margin:0;background:var(--bg);color:#111}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#202020;color:#fff}
  header h1{margin:0;font-size:1.2rem}
  header .controls{display:flex;gap:8px;align-items:center}
  button{cursor:pointer}
  .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700}
  .btn-primary{background:var(--primary);color:#000}
  .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  .container{max-width:980px;margin:20px auto;padding:0 16px;display:flex;flex-direction:column;gap:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{margin:0 0 8px 0}
  .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .date-link,.lieu-link{color:var(--primary);text-decoration:underline;cursor:pointer}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .present{background:var(--primary);color:#fff;border-radius:8px;padding:8px 10px}
  .absent{background:var(--danger);color:#fff;border-radius:8px;padding:8px 10px}
  .remove-pres{background:#777;color:#fff;border-radius:8px;padding:8px 10px}
  .participants{margin-top:10px;font-size:0.95rem;color:var(--muted)}
  .comments{margin-top:12px}
  .comment-row{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:#f1f5f8;margin-bottom:8px}
  .comment-left{font-size:0.95rem}
  .comment-right button{background:transparent;border:0;cursor:pointer;color:#c00;font-weight:700}
  .comment-form{display:flex;gap:8px;margin-top:8px}
  .comment-form input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
  .concert-img{max-width:100%;border-radius:8px;margin-top:10px}
  .small{padding:6px 10px;border-radius:8px;border:0}
  .status{margin-left:8px;font-size:0.95rem;color:var(--primary)}
  footer{max-width:980px;margin:10px auto;padding:0 16px;color:var(--muted);font-size:0.9rem}
  @media (max-width:520px){ .meta{flex-direction:column;align-items:flex-start} .comment-row{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
<header>
  <h1>Concerts √† venir</h1>
  <div class="controls">
    <button id="changePseudo" class="btn btn-ghost">Changer de pseudo</button>
    <button id="btnLogin" class="btn btn-primary">Admin</button>
  </div>
</header>

<main class="container" id="concertList">
  <div class="card">Chargement des concerts...</div>
</main>

<footer>Astuce: ton pseudo est stock√© localement sur cet appareil. Seul ce pseudo pourra supprimer ses propres commentaires/pr√©sences.</footer>

<script type="module">
/* ============================
   Dependencies Firebase v12
   ============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  doc, setDoc, addDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ======= Config Firebase =======
   Garde storageBucket en .app si tu veux rester en .app
   (on n'utilise pas Storage ici pour les uploads) */
const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.firebasestorage.app",
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ======= Pseudo local ======= */
let username = localStorage.getItem("concert_username");
function askPseudo(){
  const p = prompt("Choisis un pseudo (sera sauvegard√© localement) :", username || "");
  if(p && p.trim()){
    username = p.trim();
    localStorage.setItem("concert_username", username);
    renderStatus(`Pseudo : ${username}`);
  }
}
if(!username){
  username = prompt("Entre ton pseudo pour cette session :") || "Anonyme";
  username = username.trim() || "Anonyme";
  localStorage.setItem("concert_username", username);
}
document.getElementById("changePseudo").onclick = () => { askPseudo(); location.reload(); };

/* ======= Navigation admin ======= */
document.getElementById("btnLogin").onclick = ()=> { window.location.href = "login.html"; };

/* ======= Helpers calendar ======= */
function fmtICSDate(d){
  // d: Date -> YYYYMMDDTHHMMSSZ (UTC)
  const y = d.getUTCFullYear();
  const M = String(d.getUTCMonth()+1).padStart(2,"0");
  const D = String(d.getUTCDate()).padStart(2,"0");
  const h = String(d.getUTCHours()).padStart(2,"0");
  const m = String(d.getUTCMinutes()).padStart(2,"0");
  const s = String(d.getUTCSeconds()).padStart(2,"0");
  return `${y}${M}${D}T${h}${m}${s}Z`;
}
function createICSBlob(concert){
  // start from date + time (if time provided) else 19:00 local
  const time = concert.time || "19:00";
  const localStart = new Date(`${concert.date}T${time}`);
  const localEnd = new Date(localStart.getTime() + 2*60*60*1000); // 2h
  const dtStart = fmtICSDate(new Date(localStart));
  const dtEnd = fmtICSDate(new Date(localEnd));
  const uid = `${Date.now()}@concerts.local`;
  const lines = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//Concerts//FR",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${fmtICSDate(new Date())}`,
    `DTSTART:${dtStart}`,
    `DTEND:${dtEnd}`,
    `SUMMARY:${concert.title || ''}`,
    `DESCRIPTION:${(concert.desc||'').replace(/\r\n/g,'\\n')}`,
    `LOCATION:${concert.lieu || ''}`,
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\r\n");
  const blob = new Blob([lines], { type: "text/calendar;charset=utf-8" });
  return URL.createObjectURL(blob);
}
function googleCalendarUrl(concert){
  // produce ISO w/o punctuation: 20250101T090000Z/...
  const time = concert.time || "19:00";
  const start = new Date(`${concert.date}T${time}`);
  const end = new Date(start.getTime() + 2*60*60*1000);
  const fmt = d => d.toISOString().replace(/[-:]|\.\d{3}/g,"");
  const params = new URLSearchParams({
    action: "TEMPLATE",
    text: concert.title || "",
    details: concert.desc || "",
    location: concert.lieu || "",
    dates: `${fmt(start)}/${fmt(end)}`
  });
  return "https://calendar.google.com/calendar/render?" + params.toString();
}

/* ======= Firestore actions ======= */
async function addParticipant(concertId, name, status){
  if(!name) return;
  // use name as document id to allow easy removal by same name
  const pDoc = doc(db, "concerts", concertId, "participants", name);
  await setDoc(pDoc, { name, status, createdAt: Date.now() });
}
async function removeParticipant(concertId, name){
  if(!name) return;
  const pDoc = doc(db, "concerts", concertId, "participants", name);
  await deleteDoc(pDoc);
}
async function addComment(concertId, name, text){
  if(!name || !text) return;
  const commentsCol = collection(db, "concerts", concertId, "comments");
  await addDoc(commentsCol, { name, text, createdAt: Date.now() });
}
async function deleteComment(concertId, commentId){
  if(!commentId) return;
  await deleteDoc(doc(db, "concerts", concertId, "comments", commentId));
}

/* ======= Render real-time concerts ======= */
const container = document.getElementById("concertList");
const concertsRef = collection(db, "concerts");
const concertsQuery = query(concertsRef, orderBy("date"));

onSnapshot(concertsQuery, snapshot => {
  container.innerHTML = "";
  if(snapshot.empty){
    const c = document.createElement("div"); c.className="card"; c.innerText = "Aucun concert programm√©."; container.appendChild(c); return;
  }

  snapshot.forEach(docSnap => {
    const c = docSnap.data();
    const concertId = docSnap.id;

    const card = document.createElement("div");
    card.className = "card";

    // Image (imagePath url string from admin)
    if(c.imagePath){
      const img = document.createElement("img");
      img.src = c.imagePath;
      img.alt = c.title || "";
      img.className = "concert-img";
      card.appendChild(img);
    }

    const title = document.createElement("h2");
    title.innerText = c.title || "√âv√©nement";
    card.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "meta";
    const dateSpan = document.createElement("span");
    dateSpan.className = "date-link";
    dateSpan.innerText = `üìÖ ${c.date || ""} ${c.time || ""}`;
    dateSpan.title = "Ajouter au calendrier";
    dateSpan.onclick = () => {
      const choice = confirm("Ouvrir Google Calendar ? (OK) / T√©l√©charger .ics pour Apple/Outlook (Annuler)");
      if(choice){
        window.open(googleCalendarUrl(c), "_blank");
      } else {
        const icsUrl = createICSBlob(c);
        const a = document.createElement("a");
        a.href = icsUrl;
        a.download = `${(c.title||"evenement").replace(/\s+/g,"_")}.ics`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(icsUrl), 2000);
      }
    };
    meta.appendChild(dateSpan);

    const lieuSpan = document.createElement("span");
    lieuSpan.className = "lieu-link";
    lieuSpan.innerText = `üìç ${c.lieu || ""}`;
    lieuSpan.title = "Ouvrir dans Google Maps";
    lieuSpan.onclick = () => {
      const q = encodeURIComponent(c.lieu || "");
      window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
    };
    meta.appendChild(lieuSpan);

    card.appendChild(meta);

    // description
    const p = document.createElement("p");
    p.innerText = c.desc || "";
    card.appendChild(p);

    // actions: presence
    const actions = document.createElement("div");
    actions.className = "actions";

    const btnPresent = document.createElement("button");
    btnPresent.className = "present small";
    btnPresent.innerText = "‚úÖ Je viens";
    btnPresent.onclick = async () => {
      await addParticipant(concertId, username, "present");
    };

    const btnAbsent = document.createElement("button");
    btnAbsent.className = "absent small";
    btnAbsent.innerText = "‚ùå Je ne viens pas";
    btnAbsent.onclick = async () => {
      await addParticipant(concertId, username, "absent");
    };

    const btnRemovePres = document.createElement("button");
    btnRemovePres.className = "remove-pres small";
    btnRemovePres.innerText = "üóëÔ∏è Retirer ma pr√©sence";
    btnRemovePres.onclick = async () => {
      if(confirm("Souhaites-tu supprimer ta pr√©sence/absence pour cet √©v√©nement ?")){
        await removeParticipant(concertId, username);
      }
    };

    actions.appendChild(btnPresent);
    actions.appendChild(btnAbsent);
    actions.appendChild(btnRemovePres);
    card.appendChild(actions);

    // participants realtime
    const participantsDiv = document.createElement("div");
    participantsDiv.className = "participants";
    participantsDiv.innerHTML = "Chargement participants...";
    card.appendChild(participantsDiv);

    const partsCol = collection(db, "concerts", concertId, "participants");
    onSnapshot(partsCol, snapParts => {
      const present = [], absent = [];
      snapParts.forEach(p => {
        const d = p.data();
        if(d.status === "present") present.push(d.name);
        else if(d.status === "absent") absent.push(d.name);
      });
      participantsDiv.innerHTML = `‚úÖ Pr√©sents: ${present.join(", ") || "-"}<br>‚ùå Absents: ${absent.join(", ") || "-"}`;
    });

    // commentaires
    const commentsDiv = document.createElement("div");
    commentsDiv.className = "comments";
    commentsDiv.innerHTML = "<strong>Commentaires</strong>";
    card.appendChild(commentsDiv);

    const comCol = collection(db, "concerts", concertId, "comments");
    onSnapshot(comCol, comSnap => {
      // build list
      const list = document.createElement("div");
      list.style.marginTop = "8px";
      comSnap.forEach(docCom => {
        const data = docCom.data();
        const row = document.createElement("div");
        row.className = "comment-row";

        const left = document.createElement("div");
        left.className = "comment-left";
        left.innerHTML = `<strong>${data.name}</strong>: ${data.text}`;

        const right = document.createElement("div");
        right.className = "comment-right";

        // allow delete only for same pseudo
        if(data.name === username){
          const del = document.createElement("button");
          del.innerText = "Supprimer";
          del.onclick = async () => {
            if(confirm("Supprimer ce commentaire ?")) await deleteComment(concertId, docCom.id);
          };
          right.appendChild(del);
        }

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });

      commentsDiv.innerHTML = "<strong>Commentaires</strong>";
      commentsDiv.appendChild(list);
    });

    // add comment form
    const formDiv = document.createElement("div");
    formDiv.className = "comment-form";
    const input = document.createElement("input");
    input.placeholder = "Ton commentaire...";
    const btnAdd = document.createElement("button");
    btnAdd.className = "small";
    btnAdd.innerText = "Ajouter";
    btnAdd.onclick = async () => {
      const text = input.value.trim();
      if(!text) return alert("√âcris un commentaire.");
      await addComment(concertId, username, text);
      input.value = "";
    };
    formDiv.appendChild(input);
    formDiv.appendChild(btnAdd);
    card.appendChild(formDiv);

    container.appendChild(card);
  });
});

/* ======= petite confirmation visuelle ======= */
function renderStatus(msg){
  // affiche court message dans header (temporaire)
  let s = document.querySelector(".status-inline");
  if(!s){
    s = document.createElement("div"); s.className = "status status-inline"; s.style.marginLeft="12px";
    document.querySelector(".controls").appendChild(s);
  }
  s.innerText = msg;
  setTimeout(()=>{ if(s) s.innerText = ""; }, 3000);
}
renderStatus(`Pseudo : ${username}`);

</script>
</body>
</html>
