<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Upload Musique</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.appspot.com", // âœ… bucket correct
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const db = getFirestore(app);

// VÃ©rifie si admin connectÃ©
if(localStorage.getItem('musiques_admin') !== '1'){
  alert("AccÃ¨s admin requis !");
  location.href = 'login2.html';
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("uploadForm");
  const progress = document.getElementById("progress");
  const status = document.getElementById("status");
  const logoutBtn = document.getElementById("logout");
  const libraryBtn = document.getElementById("library");

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem('musiques_admin');
    location.href = 'index.html';
  });

  libraryBtn.addEventListener("click", () => {
    location.href = 'musique.html';
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const titre = document.getElementById("titre").value.trim();
    const artiste = document.getElementById("artiste").value.trim();
    const audioFile = document.getElementById("file").files[0];

    if(!titre || !artiste || !audioFile){
      alert("Remplis tous les champs !");
      return;
    }

    const storageRef = ref(storage, "musiques/" + Date.now() + "_" + audioFile.name);
    const uploadTask = uploadBytesResumable(storageRef, audioFile);

    uploadTask.on("state_changed", 
      (snapshot) => {
        const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        progress.value = percent;
        status.textContent = `TÃ©lÃ©versement : ${percent.toFixed(0)}%`;
      }, 
      (err) => {
        console.error(err);
        status.textContent = "Erreur lors du tÃ©lÃ©versement";
      },
      async () => {
        const url = await getDownloadURL(uploadTask.snapshot.ref);
        await addDoc(collection(db, "musiques"), {
          titre,
          artiste,
          url,
          createdAt: serverTimestamp()
        });
        status.textContent = "âœ… TÃ©lÃ©versement terminÃ© !";
        form.reset();
        progress.value = 0;
      }
    );
  });
});
</script>

<style>
body{margin:0;font-family:Inter,sans-serif;background:linear-gradient(180deg,#071026,#040619);color:white;display:flex;justify-content:center;align-items:center;height:100vh}
.wrap{background:#1e1e2f;padding:28px;border-radius:20px;width:360px;box-shadow:0 0 20px rgba(255,0,122,0.4)}
h1{text-align:center;margin-bottom:20px;color:#ff007a}
input, button, progress{width:100%;margin:8px 0;padding:10px;border-radius:8px;border:none}
input{background:#2a2a3b;color:white}
button{background:#ff007a;color:white;cursor:pointer;transition:.3s}
button:hover{background:#ff3399}
#status{text-align:center;margin-top:10px;font-size:14px}
#progress{height:8px;border-radius:4px}
.btns{display:flex;justify-content:space-between;margin-top:12px}
.btns button{width:48%}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸ“¤ Upload Musique</h1>
  <form id="uploadForm">
    <input type="text" id="titre" placeholder="Titre" required>
    <input type="text" id="artiste" placeholder="Artiste" required>
    <input type="file" id="file" accept="audio/*" required>
    <progress id="progress" value="0" max="100"></progress>
    <span id="status"></span>
    <button type="submit">Publier</button>
  </form>
  <div class="btns">
    <button id="logout">DÃ©connexion</button>
    <button id="library">Voir bibliothÃ¨que</button>
  </div>
</div>
</body>
</html>
