<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Sons – Deezer Style</title>
<style>
body { font-family:'Helvetica Neue',sans-serif; margin:0; background:#f4f4f8; color:#222; display:flex; flex-direction:column; align-items:center; padding:20px; }
header { width:100%; display:flex; justify-content:space-between; align-items:center; padding:20px 40px; background: linear-gradient(90deg,#5c4aff,#a56eff); color:#fff; }
header h1 { font-weight:700; font-size:1.5rem; margin:0; }
header button { padding:8px 16px; border:none; border-radius:20px; background:#fff; color:#5c4aff; font-weight:700; cursor:pointer; transition:0.3s; }
header button:hover { background:#f0f0f0; }

form { background:#fff; padding:24px; border-radius:15px; width:360px; display:flex; flex-direction:column; gap:16px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
input, button { width:100%; padding:12px; border-radius:15px; border:1px solid #ccc; }
input[type="file"] { padding:6px; }
button.submit-btn { background:#5c4aff; color:#fff; font-weight:700; cursor:pointer; border:none; transition:0.3s; }
button.submit-btn:hover { background:#452cb5; }

.container { max-width:900px; width:100%; display:flex; flex-direction:column; gap:20px; margin-top:20px; }
.sound-item { display:flex; align-items:center; gap:16px; padding:14px 16px; background:#fff; border-radius:15px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:0.2s; }
.sound-item:hover { box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.sound-item img { width:60px; height:60px; border-radius:12px; object-fit:cover; }
.sound-item .info { flex:1; display:flex; flex-direction:column; }
.sound-item .info strong { font-size:1rem; margin-bottom:6px; color:#222; }
.sound-item audio { width:100%; border-radius:10px; }
.sound-item .buttons { display:flex; gap:6px; }
.sound-item .buttons button { padding:6px 12px; border-radius:12px; font-weight:700; cursor:pointer; border:none; }
.sound-item .buttons .edit { background:#00ccff; color:#fff; }
.sound-item .buttons .edit:hover { background:#00b0e0; }
.sound-item .buttons .delete { background:#ff5555; color:#fff; }
.sound-item .buttons .delete:hover { background:#e04d4d; }
</style>
</head>
<body>

<header>
  <button onclick="window.location.href='musique.html'">← Retour bibliothèque</button>
  <h1>Admin Sons</h1>
  <button onclick="window.location.href='index.html'">Accueil</button>
</header>

<div class="container">
  <form id="form">
    <input type="hidden" id="soundId">
    <input id="title" placeholder="Nom du son" required>
    <input type="file" id="audio-file" accept="audio/*" required>
    <input type="file" id="cover-file" accept="image/*">
    <button type="submit" class="submit-btn">Enregistrer</button>
  </form>

  <div id="soundList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const SUPABASE_URL="https://hcjgggdnfznoitebphvs.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjamdnZ2RuZnpub2l0ZWJwaHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA1MDEsImV4cCI6MjA3NjA5NjUwMX0.evgN1B1dp8H0007N4qskRxXiAICJPajBAbgYFsPyX3s";
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY);

function sanitizeFileName(f){return f.replace(/\s+/g,"_").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]/g,"");}
function getPublicUrl(f){return `${SUPABASE_URL}/storage/v1/object/public/musics/${f}`;}

const form=document.getElementById("form");
const list=document.getElementById("soundList");

form.addEventListener("submit",async e=>{
  e.preventDefault();
  const soundId=document.getElementById("soundId").value;
  const title=document.getElementById("title").value;
  const audioFile=document.getElementById("audio-file").files[0];
  const coverFile=document.getElementById("cover-file").files[0];
  if(!audioFile) return alert("Veuillez choisir un fichier audio.");
  try{
    const audioName=`audios/${Date.now()}_${sanitizeFileName(audioFile.name)}`;
    const {error:audioError}=await supabase.storage.from('musics').upload(audioName,audioFile,{upsert:true});
    if(audioError) throw audioError;
    const audioUrl=getPublicUrl(audioName);
    let coverUrl=null;
    if(coverFile){
      const coverName=`covers/${Date.now()}_${sanitizeFileName(coverFile.name)}`;
      const {error:coverError}=await supabase.storage.from('musics').upload(coverName,coverFile,{upsert:true});
      if(coverError) throw coverError;
      coverUrl=getPublicUrl(coverName);
    }
    const dataObj={title,url:audioUrl,cover_url:coverUrl};
    if(soundId){ const {error}=await supabase.from('musics').update(dataObj).eq('id',soundId); if(error) throw error; }
    else { const {error}=await supabase.from('musics').insert([dataObj]); if(error) throw error; }
    form.reset();
    document.getElementById("soundId").value="";
    loadSounds();
  }catch(err){ alert("Erreur: "+err.message); console.error(err);}
});

async function loadSounds(){
  const {data,error}=await supabase.from('musics').select('*').order('id',{ascending:true});
  if(error){ list.innerHTML="Erreur: "+error.message; return;}
  list.innerHTML="";
  if(!data||data.length===0){ list.innerHTML="<div>Aucun son disponible.</div>"; return;}
  data.forEach(s=>{
    const div=document.createElement("div");
    div.className="sound-item";
    div.innerHTML=`
      <img src="${s.cover_url||'https://via.placeholder.com/60?text=?'}" alt="Jaquette">
      <div class="info"><strong>${s.title}</strong><audio controls src="${s.url}"></audio></div>
      <div class="buttons">
        <button class="edit" data-id="${s.id}">Modifier</button>
        <button class="delete" data-id="${s.id}">Supprimer</button>
      </div>`;
    list.appendChild(div);
    div.querySelector(".edit").onclick=()=>{ document.getElementById("soundId").value=s.id; document.getElementById("title").value=s.title; };
    div.querySelector(".delete").onclick=async()=>{ if(!confirm("Supprimer ce son ?")) return; const {error}=await supabase.from('musics').delete().eq('id',s.id); if(error) return alert("Erreur: "+error.message); loadSounds();}
  });
}
loadSounds();
</script>

</body>
</html>
