<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Upload Musique</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdVemkxmbUdYG4scag95yh5PWSszTcJpc",
  authDomain: "notifhead.firebaseapp.com",
  projectId: "notifhead",
  storageBucket: "notifhead.appspot.com",
  messagingSenderId: "190210184035",
  appId: "1:190210184035:web:fdc67599bfc79f2bf1f956",
  measurementId: "G-HWW5Z08H60"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const db = getFirestore(app);

if(localStorage.getItem('musiques_admin') !== '1'){
  alert("AccÃ¨s admin requis !");
  location.href = 'login2.html';
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("uploadForm");
  const progress = document.getElementById("progress");
  const status = document.getElementById("status");
  const logoutBtn = document.getElementById("logout");
  const libraryBtn = document.getElementById("library");

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem('musiques_admin');
    location.href = 'index.html';
  });

  libraryBtn.addEventListener("click", () => {
    location.href = 'musique.html';
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const titre = document.getElementById("titre").value.trim();
    const artiste = document.getElementById("artiste").value.trim();
    const audioFile = document.getElementById("file").files[0];

    if(!titre || !artiste || !audioFile){
      alert("Remplis tous les champs !");
      return;
    }

    const storageRef = ref(storage, "musiques/" + Date.now() + "_" + audioFile.name);
    const uploadTask = uploadBytesResumable(storageRef, audioFile);

    uploadTask.on("state_changed", 
      (snapshot) => {
        const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        progress.value = percent;
        status.textContent = `TÃ©lÃ©versement : ${percent.toFixed(0)}%`;
      }, 
      (err) => {
        console.error(err);
        status.textContent = "Erreur lors du tÃ©lÃ©versement";
      },
      async () => {
        const url = await getDownloadURL(uploadTask.snapshot.ref);
        await addDoc(collection(db, "musiques"), {
          titre,
          artiste,
          url,
          createdAt: serverTimestamp()
        });
        status.textContent = "âœ… TÃ©lÃ©versement terminÃ© !";
        form.reset();
        progress.value = 0;
      }
    );
  });
});
</script>

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#0b0b14;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.container{
  background:#12121f;
  padding:30px;
  border-radius:25px;
  width:380px;
  box-shadow:0 0 30px rgba(255,0,150,0.3);
}
h1{
  text-align:center;
  margin-bottom:25px;
  font-size:28px;
  color:#ff00aa;
}
input, button, progress{
  width:100%;
  margin:12px 0;
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:14px;
}
input{
  background:#1f1f33;
  color:white;
}
button{
  background:linear-gradient(90deg,#ff0080,#ff33aa);
  color:white;
  cursor:pointer;
  font-weight:600;
  transition:.3s;
}
button:hover{
  background:linear-gradient(90deg,#ff33aa,#ff66cc);
}
#progress{
  height:10px;
  border-radius:5px;
  background:#333;
}
#status{
  text-align:center;
  margin-top:10px;
  font-size:14px;
}
.buttons{
  display:flex;
  justify-content:space-between;
  margin-top:15px;
}
.buttons button{
  width:48%;
}
</style>
</head>
<body>
<div class="container">
  <h1>ðŸ“¤ Upload Musique</h1>
  <form id="uploadForm">
    <input type="text" id="titre" placeholder="Titre de la musique" required>
    <input type="text" id="artiste" placeholder="Artiste" required>
    <input type="file" id="file" accept="audio/*" required>
    <progress id="progress" value="0" max="100"></progress>
    <span id="status"></span>
    <button type="submit">Publier</button>
  </form>
  <div class="buttons">
    <button id="logout">DÃ©connexion</button>
    <button id="library">BibliothÃ¨que</button>
  </div>
</div>
</body>
</html>
