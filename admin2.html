<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Musiques</title>
<style>
body{font-family:'Segoe UI',sans-serif;margin:0;background:#121212;color:#fff}
header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#000}
header h1{margin:0}
header button{padding:6px 12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
header button#btnLibrary{background:#00ccff;color:#000}
header button#btnLogout{background:#ff5555;color:#fff}
.container{max-width:800px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:24px}
.card{background:#1e1e1e;padding:16px;border-radius:12px}
input,textarea,button{width:100%;margin:6px 0;padding:8px;border-radius:6px;border:none}
input[type="file"]{padding:3px}
button.save{background:#00ccff;color:#000;font-weight:bold}
button.delete{background:#ff5555;color:#fff}
.music-item{background:#2a2a2a;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.music-preview{width:50px;height:50px;border-radius:6px;object-fit:cover;margin-right:12px}
</style>
</head>
<body>
<header>
  <button id="btnLibrary">Bibliothèque</button>
  <h1>Admin Musiques</h1>
  <button id="btnLogout">Déconnexion</button>
</header>

<div class="container">
  <div class="card">
    <h2>Ajouter / Modifier une musique</h2>
    <form id="form">
      <input type="hidden" id="musicId">
      <input id="title" placeholder="Titre" required>
      <input id="artist" placeholder="Artiste">
      <input type="file" id="audio" accept="audio/*" required>
      <input type="file" id="cover" accept="image/*">
      <button type="submit" class="save">Publier</button>
    </form>
  </div>

  <h2>Liste des musiques</h2>
  <div id="musicList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl="https://hcjgggdnfznoitebphvs.supabase.co";
const supabaseKey="YOUR_PUBLIC_ANON_KEY";
const supabase=createClient(supabaseUrl,supabaseKey);

document.getElementById("btnLibrary").onclick=()=>window.location.href="musiques.html";
document.getElementById("btnLogout").onclick=()=>window.location.href="index.html";

const form=document.getElementById("form");
const list=document.getElementById("musicList");

// Nettoyage nom fichier
function sanitizeFileName(name){return name.replace(/\s+/g,"_").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]/g,"");}

form.addEventListener("submit",async e=>{
  e.preventDefault();
  const id=document.getElementById("musicId").value;
  const title=document.getElementById("title").value;
  const artist=document.getElementById("artist").value;
  const audioFile=document.getElementById("audio").files[0];
  const coverFile=document.getElementById("cover").files[0];
  if(!audioFile) return alert("Sélectionne un fichier audio");

  try{
    let audio_url=null, cover_url=null;

    if(audioFile){
      const {data,error}=await supabase.storage.from('musics').upload(`audios/${Date.now()}_${sanitizeFileName(audioFile.name)}`,audioFile,{upsert:true});
      if(error) throw error;
      audio_url=supabase.storage.from('musics').getPublicUrl(data.path).publicURL;
    }

    if(coverFile){
      const {data,error}=await supabase.storage.from('musics').upload(`covers/${Date.now()}_${sanitizeFileName(coverFile.name)}`,coverFile,{upsert:true});
      if(error) throw error;
      cover_url=supabase.storage.from('musics').getPublicUrl(data.path).publicURL;
    }

    const obj={title,artist};
    if(audio_url)obj.audio_url=audio_url;
    if(cover_url)obj.cover_url=cover_url;

    if(id){ await supabase.from('musics').update(obj).eq('id',id); }
    else{ await supabase.from('musics').insert([obj]); }

    form.reset(); document.getElementById("musicId").value="";
    loadMusics();
    alert("✅ Musique publiée !");
  }catch(err){console.error(err); alert("❌ Erreur: "+err.message);}
});

async function loadMusics(){
  const {data,error}=await supabase.from('musics').select('*').order('id',{ascending:true});
  if(error){list.innerHTML="Erreur: "+error.message; return;}
  list.innerHTML="";
  if(!data || data.length===0){list.innerHTML="Aucune musique."; return;}

  data.forEach(m=>{
    const div=document.createElement("div"); div.className="music-item";
    const coverUrl=m.cover_url||'https://via.placeholder.com/50';
    div.innerHTML=`<img src="${coverUrl}" class="music-preview"><span>${m.title} - ${m.artist||''}</span>`;
    const btnEdit=document.createElement("button"); btnEdit.className="save"; btnEdit.innerText="Modifier";
    btnEdit.onclick=()=>{
      document.getElementById("musicId").value=m.id;
      document.getElementById("title").value=m.title;
      document.getElementById("artist").value=m.artist;
    };
    const btnDelete=document.createElement("button"); btnDelete.className="delete"; btnDelete.innerText="Supprimer";
    btnDelete.onclick=async()=>{
      await supabase.from('musics').delete().eq('id',m.id);
      loadMusics();
    };
    div.appendChild(btnEdit); div.appendChild(btnDelete);
    list.appendChild(div);
  });
}

loadMusics();
</script>
</body>
</html>
