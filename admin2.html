<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Musiques</title>
<style>
body{font-family:'Segoe UI',sans-serif;margin:0;background:#121212;color:#fff}
header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#000}
header h1{margin:0}
header button{padding:6px 12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
header button#btnLibrary{background:#00ccff;color:#000}
header button#btnLogout{background:#ff5555;color:#fff}
.container{max-width:800px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:24px}
.card{background:#1e1e1e;padding:16px;border-radius:12px}
input,textarea,button{width:100%;margin:6px 0;padding:8px;border-radius:6px;border:none}
input[type="file"]{padding:3px}
button.save{background:#00ccff;color:#000;font-weight:bold}
button.delete{background:#ff5555;color:#fff}
.music-item{background:#2a2a2a;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap}
.music-item audio{width:100%;margin-top:6px}
</style>
</head>
<body>
<header>
  <button id="btnLibrary">Bibliothèque</button>
  <h1>Admin Musiques</h1>
  <button id="btnLogout">Déconnexion</button>
</header>

<div class="container">
  <div class="card">
    <h2>Ajouter une musique</h2>
    <form id="form">
      <input type="hidden" id="musicId">
      <input id="title" placeholder="Titre" required>
      <input id="artist" placeholder="Artiste">
      <input type="file" id="audio" accept="audio/*" required>
      <button type="submit" class="save">Publier</button>
    </form>
  </div>

  <h2>Liste des musiques</h2>
  <div id="musicList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://hcjgggdnfznoitebphvs.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjamdnZ2RuZnpub2l0ZWJwaHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA1MDEsImV4cCI6MjA3NjA5NjUwMX0.evgN1B1dp8H0007N4qskRxXiAICJPajBAbgYFsPyX3s";
const supabase = createClient(supabaseUrl, supabaseKey);

document.getElementById("btnLibrary").onclick = () => window.location.href = "musiques.html";
document.getElementById("btnLogout").onclick = () => window.location.href = "index.html";

function sanitizeFileName(name) {
  return name.replace(/\s+/g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9_.-]/g, '');
}

const form = document.getElementById("form");
const list = document.getElementById("musicList");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const musicId = document.getElementById("musicId").value;
  const title = document.getElementById("title").value.trim();
  const artist = document.getElementById("artist").value.trim();
  const file = document.getElementById("audio").files[0];

  if (!title) return alert("⚠️ Le titre est obligatoire.");
  if (!file && !musicId) return alert("⚠️ Sélectionne un fichier audio.");

  try {
    let audioUrl = null;
    if (file) {
      const fileName = `${Date.now()}_${sanitizeFileName(file.name)}`;
      const { data: uploadData, error: uploadError } = await supabase.storage.from('musics').upload(`audios/${fileName}`, file, { upsert: true });
      if (uploadError) throw uploadError;
      const { data: publicData } = supabase.storage.from('musics').getPublicUrl(uploadData.path);
      audioUrl = publicData.publicUrl;
    }

    const obj = { title, artist };
    if (audioUrl) obj.audio_url = audioUrl;

    if (musicId) {
      await supabase.from('musics').update(obj).eq('id', musicId);
      alert("✅ Musique modifiée !");
    } else {
      await supabase.from('musics').insert([obj]);
      alert("✅ Musique publiée !");
    }

    form.reset();
    document.getElementById("musicId").value = "";
    loadMusics();
  } catch (err) {
    console.error(err);
    alert("❌ Erreur : " + err.message);
  }
});

async function loadMusics() {
  const { data, error } = await supabase.from('musics').select('*').order('id', { ascending: true });
  if (error) { list.innerHTML = "Erreur : " + error.message; return; }

  list.innerHTML = "";
  data.forEach(m => {
    const div = document.createElement("div");
    div.className = "music-item";
    div.innerHTML = `
      <div><strong>${m.title}</strong> - ${m.artist || ""}</div>
      ${m.audio_url ? `<audio controls src="${m.audio_url}"></audio>` : ""}
    `;

    const btnEdit = document.createElement("button");
    btnEdit.innerText = "Modifier";
    btnEdit.className = "save";
    btnEdit.onclick = () => {
      document.getElementById("musicId").value = m.id;
      document.getElementById("title").value = m.title;
      document.getElementById("artist").value = m.artist;
    };

    const btnDelete = document.createElement("button");
    btnDelete.innerText = "Supprimer";
    btnDelete.className = "delete";
    btnDelete.onclick = async () => {
      if (confirm(`Supprimer "${m.title}" ?`)) {
        await supabase.from('musics').delete().eq('id', m.id);
        loadMusics();
      }
    };

    div.appendChild(btnEdit);
    div.appendChild(btnDelete);
    list.appendChild(div);
  });
}

loadMusics();
</script>
</body>
</html>
