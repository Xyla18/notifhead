<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Sons</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:#121212; color:#fff; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#000; }
header h1 { margin:0; }
header button { padding:6px 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
header button#btnBack { background:#00ccff; color:#000; }
header button#btnLogout { background:#ff5555; color:#fff; }
.container { max-width:800px; margin:24px auto; padding:0 16px; display:flex; flex-direction:column; gap:24px; }
.card { background:#1e1e1e; padding:16px; border-radius:12px; }
input,button { width:100%; margin:6px 0; padding:8px; border-radius:6px; border:none; }
input[type="file"] { padding:3px; }
button.save { background:#00ccff; color:#000; font-weight:bold; }
button.delete { background:#ff5555; color:#fff; }
.sound-item { background:#2a2a2a; padding:12px; border-radius:8px; margin-bottom:12px; display:flex; justify-content: space-between; align-items:center; }
.sound-item audio { width:60%; }
</style>
</head>
<body>

<header>
  <button id="btnBack">← Retour bibliothèque</button>
  <h1>Admin Sons</h1>
  <button id="btnLogout">Déconnexion</button>
</header>

<div class="container">
  <div class="card">
    <h2>Ajouter / Modifier un son</h2>
    <form id="form">
      <input type="hidden" id="soundId">
      <input id="title" placeholder="Nom du son" required>
      <input type="file" id="audio-file" accept="audio/*" required>
      <button type="submit" class="save">Enregistrer</button>
    </form>
  </div>

  <h2>Liste des sons</h2>
  <div id="soundList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://hcjgggdnfznoitebphvs.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjamdnZ2RuZnpub2l0ZWJwaHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA1MDEsImV4cCI6MjA3NjA5NjUwMX0.evgN1B1dp8H0007N4qskRxXiAICJPajBAbgYFsPyX3s";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// Navigation
document.getElementById("btnBack").onclick = () => { window.location.href = "musique.html"; };
document.getElementById("btnLogout").onclick = () => { window.location.href = "login.html"; };

// Nettoyage nom fichier
function sanitizeFileName(filename) {
  return filename.replace(/\s+/g,"_").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]/g,"");
}

// URL publique
function getPublicAudioUrl(filename) {
  return `${SUPABASE_URL}/storage/v1/object/public/sounds/${filename}`;
}

// Formulaire ajout/modif
const form = document.getElementById("form");
const list = document.getElementById("soundList");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const soundId = document.getElementById("soundId").value;
  const title = document.getElementById("title").value;
  const file = document.getElementById("audio-file").files[0];
  if (!file) return alert("Veuillez choisir un fichier audio.");

  try {
    const safeName = `${Date.now()}_${sanitizeFileName(file.name)}`;
    const { error } = await supabase.storage.from('sounds').upload(`audios/${safeName}`, file, { upsert:true });
    if (error) throw error;
    const audio_url = getPublicAudioUrl(`audios/${safeName}`);

    const dataObj = { title, url: audio_url };
    if (soundId) {
      const { error } = await supabase.from('sounds').update(dataObj).eq('id', soundId);
      if (error) throw error;
    } else {
      const { error } = await supabase.from('sounds').insert([dataObj]);
      if (error) throw error;
    }

    form.reset();
    document.getElementById("soundId").value = "";
    alert("✅ Son enregistré !");
    loadSounds();
  } catch(err) {
    console.error(err);
    alert("❌ Erreur: "+err.message);
  }
});

// Charger sons
async function loadSounds() {
  const { data, error } = await supabase.from('sounds').select('*').order('id', {ascending:true});
  if (error) { list.innerHTML="Erreur: "+error.message; return; }

  list.innerHTML = "";
  if (!data || data.length===0) { list.innerHTML="<div class='card'>Aucun son disponible.</div>"; return; }

  data.forEach(s => {
    const div = document.createElement("div");
    div.className="sound-item";
    div.innerHTML = `
      <span>${s.title}</span>
      <audio controls src="${s.url}"></audio>
      <div>
        <button class="edit" data-id="${s.id}">Modifier</button>
        <button class="delete" data-id="${s.id}">Supprimer</button>
      </div>
    `;
    list.appendChild(div);

    div.querySelector(".edit").onclick = () => {
      document.getElementById("soundId").value = s.id;
      document.getElementById("title").value = s.title;
    };
    div.querySelector(".delete").onclick = async () => {
      if(!confirm("Supprimer ce son ?")) return;
      const { error } = await supabase.from('sounds').delete().eq('id', s.id);
      if (error) return alert("Erreur: "+error.message);
      loadSounds();
    };
  });
}

loadSounds();
</script>
</body>
</html>
