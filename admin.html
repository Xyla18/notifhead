<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Concerts</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:#121212; color:#fff; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#000; }
header h1 { margin:0; }
header button { padding:6px 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
header button#btnLogout { background:#ff5555; color:#fff; }
header button#btnBack { background:#00ccff; color:#000; }
.container { max-width:800px; margin:24px auto; padding:0 16px; display:flex; flex-direction:column; gap:24px; }
.card { background:#1e1e1e; padding:16px; border-radius:12px; }
input,textarea,button { width:100%; margin:6px 0; padding:8px; border-radius:6px; border:none; }
input[type="file"] { padding:3px; }
button.save { background:#00ccff; color:#000; font-weight:bold; }
button.delete { background:#ff5555; color:#fff; }
.concert-item { background:#2a2a2a; padding:12px; border-radius:8px; margin-bottom:12px; }
img.concert-img { max-width:100%; border-radius:8px; margin-top:6px; object-fit:cover; }
</style>
</head>
<body>

<header>
  <button id="btnBack">← Retour</button>
  <h1>Admin Concerts</h1>
  <button id="btnLogout">Déconnexion</button>
</header>

<div class="container">
  <div class="card">
    <h2>Ajouter / Modifier un concert</h2>
    <form id="form">
      <input type="hidden" id="concertId">
      <input id="title" placeholder="Titre" required>
      <input type="date" id="date">
      <input type="time" id="time">
      <input id="lieu" placeholder="Lieu">
      <input type="file" id="image" accept="image/*">
      <textarea id="desc" placeholder="Description"></textarea>
      <button type="submit" class="save">Enregistrer</button>
    </form>
  </div>

  <h2>Liste des concerts</h2>
  <div id="concertList">Chargement...</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://hcjgggdnfznoitebphvs.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjamdnZ2RuZnpub2l0ZWJwaHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA1MDEsImV4cCI6MjA3NjA5NjUwMX0.evgN1B1dp8H0007N4qskRxXiAICJPajBAbgYFsPyX3s";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

document.getElementById("btnBack").onclick = ()=>{ window.location.href="index.html"; };
document.getElementById("btnLogout").onclick = ()=>{ window.location.href="login.html"; };

const form = document.getElementById("form");
const list = document.getElementById("concertList");

function sanitizeFileName(filename){
  return filename.replace(/\s+/g,"_").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]/g,"");
}

const fallbackImage = "https://via.placeholder.com/400x200?text=Image+non+disponible";

// Ajouter / Modifier concert
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const concertId = document.getElementById("concertId").value;
  const title = document.getElementById("title").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const lieu = document.getElementById("lieu").value;
  const desc = document.getElementById("desc").value;
  const file = document.getElementById("image").files[0];

  try{
    let image_url = null;
    if(file){
      const safeName = `${Date.now()}_${sanitizeFileName(file.name)}`;
      const { data, error } = await supabase.storage.from('concerts').upload(`images/${safeName}`, file, {upsert:true});
      if(error) throw error;
      const { publicURL } = supabase.storage.from('concerts').getPublicUrl(data.path);
      image_url = publicURL;
    }

    const dataObj = { title, date, time, lieu, desc };
    if(image_url) dataObj.image_url = image_url;

    if(concertId){
      const { error } = await supabase.from('concerts').update(dataObj).eq('id', concertId);
      if(error) throw error;
    } else{
      const { error } = await supabase.from('concerts').insert([dataObj]);
      if(error) throw error;
    }

    form.reset();
    document.getElementById("concertId").value="";
    alert("✅ Concert enregistré !");
    loadConcerts();
  }catch(err){
    console.error(err);
    alert("❌ Erreur: " + err.message);
  }
});

// Liste des concerts
async function loadConcerts(){
  const { data, error } = await supabase.from('concerts').select('*').order('date',{ascending:true});
  if(error){ list.innerHTML="Erreur: "+error.message; console.error(error); return; }

  list.innerHTML="";
  if(!data || data.length===0){ list.innerHTML="<div class='card'>Aucun concert programmé.</div>"; return; }

  data.forEach(c=>{
    const div = document.createElement("div");
    div.className="concert-item";
    div.innerHTML=`
      ${c.image_url ? `<img src="${c.image_url}" class="concert-img" onerror="this.src='${fallbackImage}'">` : `<img src='${fallbackImage}' class='concert-img'>`}
      <strong>${c.title}</strong> - ${c.date || ''} ${c.time || ''}<br>
      <em>${c.lieu || ''}</em><br>
      ${c.desc || ''}<br>
      <button class="edit" data-id="${c.id}">Modifier</button>
      <button class="delete" data-id="${c.id}">Supprimer</button>
    `;
    list.appendChild(div);

    div.querySelector(".edit").onclick = ()=>{
      document.getElementById("concertId").value = c.id;
      document.getElementById("title").value = c.title;
      document.getElementById("date").value = c.date;
      document.getElementById("time").value = c.time;
      document.getElementById("lieu").value = c.lieu;
      document.getElementById("desc").value = c.desc;
    };

    div.querySelector(".delete").onclick = async ()=>{
      const { error } = await supabase.from('concerts').delete().eq('id', c.id);
      if(error) return alert("Erreur: "+error.message);
      loadConcerts();
    };
  });
}

loadConcerts();
</script>
</body>
</html>
